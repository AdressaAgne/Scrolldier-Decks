(function(){"use strict";var t=this,i=t.Chart,s=i.helpers,o={scaleBeginAtZero:!0,scaleShowGridLines:!0,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,barShowStroke:!1,barStrokeWidth:0,barValueSpacing:3,relativeBars:!1,legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].fillColor%>"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>',showTotal:!1,totalColor:"#fff",totalLabel:"Total"};i.Type.extend({name:"StackedBar",defaults:o,initialize:function(t){var o=this.options;this.ScaleClass=i.Scale.extend({offsetGridLines:!0,calculateBarX:function(t){return this.calculateX(t)},calculateBarY:function(t,i,s,e){for(var a=0,l=0,n=0;n<t.length;n++)l+=t[n].bars[s].value;for(n=i;n<t.length;n++)n===i&&e?a+=e:a=+a+ +t[n].bars[s].value;return o.relativeBars&&(a=a/l*100),this.calculateY(a)},calculateBaseWidth:function(){return this.calculateX(1)-this.calculateX(0)-2*o.barValueSpacing},calculateBaseHeight:function(){return this.calculateY(1)-this.calculateY(0)},calculateBarWidth:function(t){return this.calculateBaseWidth()},calculateBarHeight:function(t,i,s,e){for(var a=0,l=0;l<t.length;l++)a+=t[l].bars[s].value;return e||(e=t[i].bars[s].value),o.relativeBars&&(e=e/a*100),this.calculateY(e)}}),this.datasets=[],this.options.showTooltips&&s.bindEvents(this,this.options.tooltipEvents,function(t){var i="mouseout"!==t.type?this.getBarsAtEvent(t):[];this.eachBars(function(t){t.restore(["fillColor","strokeColor"])}),s.each(i,function(t){t.fillColor=t.highlightFill,t.strokeColor=t.highlightStroke}),this.showTooltip(i)}),this.BarClass=i.Rectangle.extend({strokeWidth:this.options.barStrokeWidth,showStroke:this.options.barShowStroke,ctx:this.chart.ctx}),s.each(t.datasets,function(i,o){var e={label:i.label||null,fillColor:i.fillColor,strokeColor:i.strokeColor,bars:[]};this.datasets.push(e),s.each(i.data,function(o,a){s.isNumber(o)&&e.bars.push(new this.BarClass({value:s.isNumber(o)?o:0,label:t.labels[a],datasetLabel:i.label,strokeColor:i.strokeColor,fillColor:i.fillColor,highlightFill:i.highlightFill||i.fillColor,highlightStroke:i.highlightStroke||i.strokeColor}))},this)},this),this.buildScale(t.labels),this.eachBars(function(t,i,o){s.extend(t,{base:this.scale.endPoint,height:0,width:this.scale.calculateBarWidth(this.datasets.length),x:this.scale.calculateBarX(i),y:this.scale.endPoint}),t.save()},this),this.render()},showTooltip:function(t,o){"undefined"==typeof this.activeElements&&(this.activeElements=[]),s=i.helpers;var e=function(t){var i=!1;return t.length!==this.activeElements.length?i=!0:(s.each(t,function(t,s){t!==this.activeElements[s]&&(i=!0)},this),i)}.call(this,t);if(e||o){if(this.activeElements=t,this.draw(),this.options.customTooltips&&this.options.customTooltips(!1),t.length>0)if(this.datasets&&this.datasets.length>1){for(var a,l,n=this.datasets.length-1;n>=0&&(a=this.datasets[n].points||this.datasets[n].bars||this.datasets[n].segments,l=s.indexOf(a,t[0]),-1===l);n--);var h=[],r=[],c=function(t){var i=[],o,e=[],a=[],n,c,p,u;s.each(this.datasets,function(t){o=t.points||t.bars||t.segments,o[l]&&o[l].hasValue()&&i.push(o[l])});var d={datasetLabel:this.options.totalLabel,value:0,fillColor:this.options.totalColor,strokeColor:this.options.totalColor};return s.each(i,function(t){e.push(t.x),a.push(t.y),d.value+=t.value,h.push(s.template(this.options.multiTooltipTemplate,t)),r.push({fill:t._saved.fillColor||t.fillColor,stroke:t._saved.strokeColor||t.strokeColor})},this),this.options.showTotal&&(h.push(s.template(this.options.multiTooltipTemplate,d)),r.push({fill:d.fillColor,stroke:d.strokeColor})),u=s.min(a),c=s.max(a),p=s.min(e),n=s.max(e),{x:p>this.chart.width/2?p:n,y:(u+c)/2}}.call(this,l);new i.MultiTooltip({x:c.x,y:c.y,xPadding:this.options.tooltipXPadding,yPadding:this.options.tooltipYPadding,xOffset:this.options.tooltipXOffset,fillColor:this.options.tooltipFillColor,textColor:this.options.tooltipFontColor,fontFamily:this.options.tooltipFontFamily,fontStyle:this.options.tooltipFontStyle,fontSize:this.options.tooltipFontSize,titleTextColor:this.options.tooltipTitleFontColor,titleFontFamily:this.options.tooltipTitleFontFamily,titleFontStyle:this.options.tooltipTitleFontStyle,titleFontSize:this.options.tooltipTitleFontSize,cornerRadius:this.options.tooltipCornerRadius,labels:h,legendColors:r,legendColorBackground:this.options.multiTooltipKeyBackground,title:t[0].label,chart:this.chart,ctx:this.chart.ctx,custom:this.options.customTooltips}).draw()}else s.each(t,function(t){var o=t.tooltipPosition();new i.Tooltip({x:Math.round(o.x),y:Math.round(o.y),xPadding:this.options.tooltipXPadding,yPadding:this.options.tooltipYPadding,fillColor:this.options.tooltipFillColor,textColor:this.options.tooltipFontColor,fontFamily:this.options.tooltipFontFamily,fontStyle:this.options.tooltipFontStyle,fontSize:this.options.tooltipFontSize,caretHeight:this.options.tooltipCaretSize,cornerRadius:this.options.tooltipCornerRadius,text:s.template(this.options.tooltipTemplate,t),chart:this.chart,custom:this.options.customTooltips}).draw()},this);return this}},update:function(){this.scale.update(),s.each(this.activeElements,function(t){t.restore(["fillColor","strokeColor"])}),this.eachBars(function(t){t.save()}),this.render()},eachBars:function(t){s.each(this.datasets,function(i,o){s.each(i.bars,t,this,o)},this)},getBarsAtEvent:function(t){for(var i=[],o=s.getRelativePosition(t),e=function(t){i.push(t.bars[a])},a,l=0;l<this.datasets.length;l++)for(a=0;a<this.datasets[l].bars.length;a++)if(this.datasets[l].bars[a].inRange(o.x,o.y))return s.each(this.datasets,e),i;return i},buildScale:function(t){var i=this,o=function(){var t=[];return s.each(i.datasets,function(o){s.each(o.bars,function(s,o){t[o]||(t[o]=0),i.options.relativeBars?t[o]=100:t[o]=+t[o]+ +s.value})}),t},e={templateString:this.options.scaleLabel,height:this.chart.height,width:this.chart.width,ctx:this.chart.ctx,textColor:this.options.scaleFontColor,fontSize:this.options.scaleFontSize,fontStyle:this.options.scaleFontStyle,fontFamily:this.options.scaleFontFamily,valuesCount:t.length,beginAtZero:this.options.scaleBeginAtZero,integersOnly:this.options.scaleIntegersOnly,calculateYRange:function(t){var i=s.calculateScaleRange(o(),t,this.fontSize,this.beginAtZero,this.integersOnly);s.extend(this,i)},xLabels:this.options.xLabels||t,font:s.fontString(this.options.scaleFontSize,this.options.scaleFontStyle,this.options.scaleFontFamily),lineWidth:this.options.scaleLineWidth,lineColor:this.options.scaleLineColor,gridLineWidth:this.options.scaleShowGridLines?this.options.scaleGridLineWidth:0,gridLineColor:this.options.scaleShowGridLines?this.options.scaleGridLineColor:"rgba(0,0,0,0)",padding:this.options.showScale?0:this.options.barShowStroke?this.options.barStrokeWidth:0,showLabels:this.options.scaleShowLabels,display:this.options.showScale};this.options.scaleOverride&&s.extend(e,{calculateYRange:s.noop,steps:this.options.scaleSteps,stepValue:this.options.scaleStepWidth,min:this.options.scaleStartValue,max:this.options.scaleStartValue+this.options.scaleSteps*this.options.scaleStepWidth}),this.scale=new this.ScaleClass(e)},addData:function(t,i){s.each(t,function(t,o){s.isNumber(t)&&this.datasets[o].bars.push(new this.BarClass({value:s.isNumber(t)?t:0,label:i,x:this.scale.calculateBarX(this.scale.valuesCount+1),y:this.scale.endPoint,width:this.scale.calculateBarWidth(this.datasets.length),base:this.scale.endPoint,strokeColor:this.datasets[o].strokeColor,fillColor:this.datasets[o].fillColor}))},this),this.scale.addXLabel(i),this.update()},removeData:function(){this.scale.removeXLabel(),s.each(this.datasets,function(t){t.bars.shift()},this),this.update()},reflow:function(){s.extend(this.BarClass.prototype,{y:this.scale.endPoint,base:this.scale.endPoint});var t=s.extend({height:this.chart.height,width:this.chart.width});this.scale.update(t)},draw:function(t){var i=t||1;this.clear();var o=this.chart.ctx;this.scale.draw(i),s.each(this.datasets,function(t,o){s.each(t.bars,function(t,s){var e=this.scale.calculateBarY(this.datasets,o,s,t.value),a=this.scale.calculateBarHeight(this.datasets,o,s,t.value);t.transition({base:this.scale.endPoint-(Math.abs(a)-Math.abs(e)),x:this.scale.calculateBarX(s),y:Math.abs(e),height:Math.abs(a),width:this.scale.calculateBarWidth(this.datasets.length)},i).draw()},this)},this)}})}).call(this);